<div style="display: flex; gap: 10px; flex-wrap: wrap">
  <h2 style="text-align: center; color: #8b0000; margin-top: 0px">
    <button onclick="toggleRead()">
      <span id="button-text">ğŸ“– Äá»ŒC Ná»˜I DUNG TRANG</span>
      <span id="arrow-icon" class="arrow">â¬‡ï¸</span>
    </button>
  </h2>
  <h2 style="text-align: center; color: #8b0000; margin-top: 0px">
    <button id="ttsBtn" onclick="toggleTTS()">ğŸ”Š NGHE Ná»˜I DUNG TRANG</button>
  </h2>
  <select id="voiceSelect">
    <option value="">CHá»ŒN GIá»ŒNG Äá»ŒC</option>
  </select>
</div>

<hr />
<div id="output"></div>

<script>
  let isLoaded = false;
  let isSpeaking = false;
  let utterance;
  let sentenceQueue = [];
  let currentIdx = 0;
  let voices = [];

  // âœ… HÃ€M Bá» EMOJI/BIá»‚U TÆ¯á»¢NG TRONG VÄ‚N Báº¢N
  function removeEmojis(text) {
    return text.replace(
      /[\u{1F600}-\u{1F6FF}\u{1F300}-\u{1F5FF}\u{1F700}-\u{1F77F}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu,
      ""
    );
  }

  function toggleRead() {
    const output = document.getElementById("output");
    const btnText = document.getElementById("button-text");
    const arrow = document.getElementById("arrow-icon");

    if (!isLoaded) {
      const elements = Array.from(
        document.querySelectorAll("p, h1, h2, h3, li, blockquote")
      );

      // âœ… Lá»ŒC VÄ‚N Báº¢N + Bá» ICON
      const text = elements
        .map((el) => removeEmojis(el.innerText.trim()))
        .filter((s) => s.length > 0)
        .join("\n");

      // âœ… CHIA CÃ‚U
      const sentences = text.split(/(?<=[.?!])\s+/);
      output.innerHTML = sentences
        .map((s, i) => `<span id="sent-${i}">${s}</span>`)
        .join(" ");
      sentenceQueue = sentences;
      isLoaded = true;
    }

    if (output.classList.contains("show")) {
      output.classList.remove("show");
      btnText.innerText = "ğŸ“– Äá»ŒC Ná»˜I DUNG TRANG";
      arrow.innerText = "â¬‡ï¸";
      stopTTS();
    } else {
      output.classList.add("show");
      btnText.innerText = "ğŸ”½ áº¨N Ná»˜I DUNG TRANG â¬†ï¸";
      arrow.innerText = "â¬†ï¸";
    }
  }

  function toggleTTS() {
    if (!isSpeaking) {
      startReading();
    } else {
      stopTTS();
    }
  }

  function startReading() {
    isSpeaking = true;
    currentIdx = 0;
    document.getElementById("ttsBtn").innerText = "â¹ï¸ Dá»ªNG Ná»˜I DUNG TRANG";
    readNextSentence();
  }

  function readNextSentence() {
    if (currentIdx >= sentenceQueue.length) {
      stopTTS();
      return;
    }

    highlightSentence(currentIdx);

    utterance = new SpeechSynthesisUtterance(sentenceQueue[currentIdx]);
    utterance.lang = "vi-VN";

    // ğŸ”Š GÃ¡n giá»ng náº¿u cÃ³ chá»n
    const voiceSelect = document.getElementById("voiceSelect");
    const selectedVoiceURI = voiceSelect.value;
    if (selectedVoiceURI) {
      const found = voices.find((v) => v.voiceURI === selectedVoiceURI);
      if (found) utterance.voice = found;
    }

    utterance.onend = () => {
      unhighlightSentence(currentIdx);
      currentIdx++;
      if (isSpeaking) readNextSentence();
    };

    speechSynthesis.speak(utterance);
  }

  function stopTTS() {
    speechSynthesis.cancel();
    isSpeaking = false;
    document.getElementById("ttsBtn").innerText = "ğŸ”Š NGHE Ná»˜I DUNG TRANG";
    unhighlightSentence(currentIdx);
  }

  function highlightSentence(idx) {
    const el = document.getElementById(`sent-${idx}`);
    if (el) el.classList.add("highlight");
  }

  function unhighlightSentence(idx) {
    const el = document.getElementById(`sent-${idx}`);
    if (el) el.classList.remove("highlight");
  }

  // ğŸ”ˆ Láº¥y danh sÃ¡ch giá»ng Ä‘á»c tiáº¿ng Viá»‡t
  function loadVoices() {
    voices = speechSynthesis.getVoices();
    const voiceSelect = document.getElementById("voiceSelect");
    voiceSelect.innerHTML = `<option value="">CHá»ŒN GIá»ŒNG Äá»ŒC</option>`;
    voices
      .filter(
        (v) =>
          v.lang.startsWith("vi") || v.name.toLowerCase().includes("vietnam")
      )
      .forEach((v) => {
        const opt = document.createElement("option");
        opt.value = v.voiceURI;
        opt.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(opt);
      });
  }

  speechSynthesis.onvoiceschanged = loadVoices;

  // ğŸŒ™ Tá»± Ä‘á»™ng chuyá»ƒn ná»n sÃ¡ng/tá»‘i
  function autoSetTheme() {
    const hour = new Date().getHours();
    const body = document.body;
    if (hour >= 18 || hour < 6) {
      body.classList.add("dark");
      body.classList.remove("light");
    } else {
      body.classList.add("light");
      body.classList.remove("dark");
    }
  }

  autoSetTheme();
</script>

<style>
  .highlight {
    background-color: yellow;
    transition: background-color 0.3s ease;
  }
</style>
